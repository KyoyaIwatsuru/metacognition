#!/usr/bin/env sh
set -euo pipefail

cd -- "$(dirname -- "$0")/.."

echo "== lint-staged =="
bun run lint-staged

if git diff --cached --name-only --relative |
    grep -Eq '^(src/|tests/|package\.json|tsconfig\.json|jest\.config)'; then
    echo "== JS/TS tests =="
    bun run test
else
    echo "== JS/TS tests skipped (no staged frontend changes) =="
fi

if git diff --cached --name-only --relative | grep -q '^src-tauri/'; then
    echo "== Rust format check =="
    (
        cd src-tauri
        cargo fmt --all -- --check
    )

    echo "== Rust clippy =="
    (
        cd src-tauri
        cargo clippy --all-targets --all-features -- -D warnings
    )

    echo "== Rust tests =="
    (
        cd src-tauri
        cargo test
    )
else
    echo "== Rust checks skipped (no staged changes) =="
fi

echo "== Python format & lint & type check =="
(
    cd ../backend
    uv run pre-commit run --hook-stage commit
)

if git diff --cached --name-only | grep -q '^backend/'; then
    echo "== Python tests =="
    (
        cd ../backend
        if ! uv run pytest; then
            status=$?
            if [ "$status" -ne 5 ]; then
                exit "$status"
            fi
        fi
    )
else
    echo "== Python tests skipped (no staged backend changes) =="
fi
